<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-search/paper-search.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="airports-api.html">
<link rel="import" href="airports-airport-card.html">
<link rel="import" href="airports-runway-card.html">

<dom-module id="airports-query">
  <template>
    <style>
    :host {
    }

    .results {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    airports-airport-card {
      margin-bottom: 10px;
    }

    .button-wrapper {
      @apply(--layout-vertical);
      @apply(--layout-center);
    }

    paper-button {
      color: white;
      background-color: var(--app-accent-color);
      width: 100%;
    }

    .load-more {
      width: 500px;
    }

    .no-result-message {
      margin: 30px;
      text-align: center;
      font-size: 20px;
      color: #bbb;
    }

    @media (max-width: 767px) {

      .load-more {
        width: 100%;
      }
    }
    </style>

    <airports-api id="api" base="[[apiBase]]"></airports-api>

    <paper-search-bar
      placeholder="Search Country"
      hide-filter-button
      query="{{search}}"
      on-paper-search-search="_query">
    </paper-search-bar>

    <div class="results">
      <template is="dom-repeat" items="[[runways]]">
        <airports-runway-card data="[[item]]"></airports-runway-card>
      </template>
      <template is="dom-repeat" items="[[airports]]">
        <airports-airport-card data="[[item]]"></airports-airport-card>
      </template>
      <div class="no-result-message" hidden="{{!noResults}}">Airport {{search}} has no registered runways.</div>
    </div>

    <div class="button-wrapper">
      <paper-button raised hidden="{{hideLoadMore}}" on-tap="_loadMore">Load More</paper-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'airports-query',

      properties: {

        search: String,

        apiBase: String,

        page: Number,

        hideLoadMore: {
          type: Boolean,
          value: true
        }
      },

      listeners: {
        'load-runways': '_loadRunways'
      },

      _query: function () {
        var self = this;
        this.runways = [];
        this.airports = [];
        this.page = 1;
        this.noResults = false;
        this.hideLoadMore = true;
        this.$.api.search(this.search.replace('#', '$'), function (result) {
          if (typeof result.data === 'undefined' || result.data.length == 0) {
            self.noResults = true;
            return
          }
          if (result.type == "airports") {
            var airports = result.data;
            self.search = result.code;
            self.airports = airports;
            if (airports.length == 0 || airports.length < 10)
              self.hideLoadMore = true;
            else
              self.hideLoadMore = false;
          } else if (result.type == "runways") {
            self.runways = result.data;
            self.hideLoadMore = true;
          }
        });
      },

      _loadMore: function () {
        var self = this;
        this.$.api.airportsPage(this.search, ++this.page, function (airports) {
          for (var i in airports) {
            self.push('airports', airports[i])
          }
          if (airports.length == 0 || airports.length < 10)
            self.hideLoadMore = true;
          else
            self.hideLoadMore = false;
        });
      },

      _loadRunways: function (event) {
        this.search = '#'+event.detail;
        Polymer.AppLayout.scroll({ top: 0, behavior: 'smooth' });
        this._query();
      }
    });
  </script>
</dom-module>
